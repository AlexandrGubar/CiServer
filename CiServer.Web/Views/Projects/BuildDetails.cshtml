@model CiServer.Core.Entities.Build
@{ 
    ViewData["Title"] = "Build Console"; 
    Layout = null;
    string statusLower = Model.Status.ToString().ToLower();
    string statusColor = statusLower == "success" ? "#198754" : (statusLower == "failed" ? "#dc3545" : "#ffc107");
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Build #@Model.BuildId.ToString().Substring(0,8) - Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Верхня панель */
        .top-bar {
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-dot {
            height: 12px; width: 12px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 8px;
            background-color: @statusColor;
            box-shadow: 0 0 10px @statusColor;
        }

        /* Консоль */
        .console-container {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            background-color: #0d0d0d;
        }

        .log-line { border-left: 2px solid transparent; padding-left: 10px; margin-bottom: 2px; }
        .log-line:hover { background-color: #1a1a1a; border-left-color: #444; }
        
        .ts { color: #569cd6; margin-right: 15px; opacity: 0.7; }
        .txt { color: #d4d4d4; }
        
        .log-success .txt { color: #4ec9b0; font-weight: bold; }
        .log-error .txt { color: #f44747; font-weight: bold; }
        .log-start .txt { color: #c586c0; }

        /* Кнопка назад */
        .btn-back {
            color: #888; text-decoration: none; font-weight: 500;
            transition: 0.2s; display: flex; align-items: center;
        }
        .btn-back:hover { color: white; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="d-flex align-items-center">
            <a href="/Projects/Details/@Model.ProjectId" class="btn-back me-4">
                <i class="bi bi-arrow-left me-2"></i> Назад
            </a>
            <div>
                <h5 class="mb-0 fw-bold text-white">
                    <span class="status-dot" id="statusDot"></span>
                    Build #@Model.BuildId.ToString().Substring(0, 8)
                </h5>
                <small class="text-secondary" id="statusText">@Model.Status | @Model.StartTime.ToLocalTime()</small>
            </div>
        </div>

        <div id="artifactsArea">
            @if(Model.Artifacts != null && Model.Artifacts.Any())
            {
                foreach(var artifact in Model.Artifacts)
                {
                    <a href="@artifact.FilePath" class="btn btn-primary btn-sm fw-bold shadow">
                        <i class="bi bi-box-seam me-2"></i> Завантажити Artifact (.zip)
                    </a>
                }
            }
            else if (Model.Status == CiServer.Core.Entities.BuildStatus.Running)
            {
                <span class="text-warning small"><span class="spinner-border spinner-border-sm me-2"></span> Збірка триває...</span>
            }
        </div>
    </div>

    <div id="consoleOutput" class="console-container">
        @foreach (var log in Model.Logs.OrderBy(l => l.Timestamp))
        {
            string lineClass = "";
            if (log.Content.Contains("[Success]")) lineClass = "log-success";
            else if (log.Content.Contains("[Error]")) lineClass = "log-error";
            else if (log.Content.Contains("[Start]")) lineClass = "log-start";

            <div class="log-line @lineClass">
                <span class="ts">@log.Timestamp.ToString("HH:mm:ss")</span>
                <span class="txt">@log.Content</span>
            </div>
        }
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const buildId = "@Model.BuildId";
        const consoleBox = document.getElementById("consoleOutput");
        const statusText = document.getElementById("statusText");
        const statusDot = document.getElementById("statusDot");

        // Автоскрол вниз
        consoleBox.scrollTop = consoleBox.scrollHeight;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/buildHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveLog", function (message, time) {
            const div = document.createElement("div");
            
            let lineClass = "";
            if (message.includes("[Success]")) lineClass = "log-success";
            if (message.includes("[Error]")) lineClass = "log-error";
            if (message.includes("[Start]")) lineClass = "log-start";
            
            div.className = "log-line " + lineClass;
            div.innerHTML = `<span class="ts">${time}</span><span class="txt">${message}</span>`;
            
            consoleBox.appendChild(div);
            consoleBox.scrollTop = consoleBox.scrollHeight;
        });

        connection.on("BuildFinished", function (status) {
            statusText.innerText = status + " (Оновлення...)";
            if(status === "Success") statusDot.style.backgroundColor = "#198754";
            else statusDot.style.backgroundColor = "#dc3545";
            
            setTimeout(() => location.reload(), 1500);
        });

        connection.start()
            .then(() => connection.invoke("JoinBuildGroup", buildId))
            .catch(err => console.error(err));
    </script>

</body>
</html>