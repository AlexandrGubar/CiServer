@model CiServer.Core.Entities.Build

@{
    ViewData["Title"] = "–î–µ—Ç–∞–ª—ñ –∑–±—ñ—Ä–∫–∏";
    // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–ª—ñ—Ä —Å—Ç–∞—Ç—É—Å—É
    string statusClass = Model.Status.ToString() switch {
        "Success" => "alert-success",
        "Failed" => "alert-danger",
        "Running" => "alert-warning",
        _ => "alert-secondary"
    };
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Build Details</h2>
        <a asp-action="Details" asp-route-id="@Model.ProjectId" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥ –¥–æ –ø—Ä–æ—î–∫—Ç—É</a>
    </div>

    <div id="statusAlert" class="alert @statusClass d-flex justify-content-between align-items-center">
        <span>
            <strong>Status:</strong> <span id="statusText">@Model.Status</span>
            <span class="ms-3 text-muted small">ID: @Model.BuildId</span>
        </span>
        
        <div id="artifactsArea">
            @foreach(var artifact in Model.Artifacts)
            {
                <a href="@artifact.FilePath" class="btn btn-primary btn-sm">
                    üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ (@artifact.FilePath.Split('/').Last())
                </a>
            }
        </div>
    </div>

    <h3>Console Output</h3>
    <div id="consoleOutput" style="background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace; padding: 15px; height: 500px; overflow-y: auto; border-radius: 5px; border: 1px solid #333;">
        @foreach (var log in Model.Logs.OrderBy(l => l.Timestamp))
        {
            <div class="log-line">
                <span style="color: #569cd6;">[@log.Timestamp.ToString("HH:mm:ss")]</span>
                <span>@log.Content</span>
            </div>
        }
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
    const buildId = "@Model.BuildId";
    const statusText = document.getElementById("statusText");
    const statusAlert = document.getElementById("statusAlert");
    const consoleBox = document.getElementById("consoleOutput");

    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    consoleBox.scrollTop = consoleBox.scrollHeight;

    // 1. –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ SignalR Hub
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/buildHub")
        .build();

    // 2. –ü—Ä–∏–π–æ–º –ª–æ–≥—ñ–≤
    connection.on("ReceiveLog", function (message, time) {
        const div = document.createElement("div");
        div.className = "log-line";
        
        // –†–æ–∑—Ñ–∞—Ä–±–æ–≤—É—î–º–æ Start/Success/Error –¥–ª—è –∫—Ä–∞—Å–∏
        let contentColor = "#d4d4d4"; // —Å—ñ—Ä–∏–π (–¥–µ—Ñ–æ–ª—Ç)
        if (message.includes("[Success]")) contentColor = "#4ec9b0"; // –∑–µ–ª–µ–Ω–∏–π
        if (message.includes("[Error]")) contentColor = "#f44747";   // —á–µ—Ä–≤–æ–Ω–∏–π
        if (message.includes("[Start]")) contentColor = "#c586c0";   // —Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π

        div.innerHTML = `<span style="color: #569cd6;">[${time}]</span> <span style="color: ${contentColor};">${message}</span>`;
        
        consoleBox.appendChild(div);
        consoleBox.scrollTop = consoleBox.scrollHeight; // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª
    });

    // 3. –ü—Ä–∏–π–æ–º –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É (–∫–æ–ª–∏ –±—ñ–ª–¥ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è)
    connection.on("BuildFinished", function (status) {
        statusText.innerText = status;
        
        // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä –ø–ª–∞—à–∫–∏
        statusAlert.classList.remove("alert-secondary", "alert-warning", "alert-success", "alert-danger");
        if (status === "Success") statusAlert.classList.add("alert-success");
        else statusAlert.classList.add("alert-danger");

        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫, —â–æ–± –∑'—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏"
        setTimeout(() => location.reload(), 1500);
    });

    // 4. –°—Ç–∞—Ä—Ç –∑'—î–¥–Ω–∞–Ω–Ω—è
    connection.start()
        .then(() => {
            console.log("SignalR Connected.");
            connection.invoke("JoinBuildGroup", buildId);
        })
        .catch(err => console.error(err.toString()));
</script>